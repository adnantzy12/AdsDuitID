<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-9697754978669232">
    <title>Referral - AdsDuitID</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="dashboard.html" class="navbar-brand">
                <img src="../images/logo.png" alt="AdsDuitID">
                <span>AdsDuitID</span>
            </a>
            <ul class="navbar-nav">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="earn.html">Mulai Kerja</a></li>
                <li><a href="withdraw.html">Penarikan</a></li>
                <li><a href="referral.html" class="active">Referral</a></li>
                <li><a href="#" onclick="logout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </div>
    </nav>

    <div class="dashboard">
        <div class="dashboard-container">
            <h1 style="font-size: 1.5rem; margin-bottom: 2rem;"><i class="fas fa-user-plus" style="color: var(--primary); margin-right: 0.5rem;"></i>Program Referral</h1>
            
            <!-- Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="totalReferred">0</div>
                    <div class="stat-label">Teman Diundang</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-value" id="activeReferred">0</div>
                    <div class="stat-label">Aktif</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-value" id="refEarnings">Rp 0</div>
                    <div class="stat-label">Total Bonus</div>
                </div>
            </div>
            
            <!-- Referral Link -->
            <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(245, 158, 11, 0.05) 100%); border: 2px dashed rgba(16, 185, 129, 0.3);">
                <div class="card-body">
                    <h3 style="margin-bottom: 1rem;"><i class="fas fa-link" style="color: var(--primary); margin-right: 0.5rem;"></i>Link Referral Anda</h3>
                    <p style="color: var(--gray); margin-bottom: 1.5rem;">Bagikan link ini ke teman-teman Anda dan dapatkan bonus!</p>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <input type="text" id="referralLink" readonly style="flex: 1; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-size: 0.875rem; background: white;">
                        <button class="btn btn-primary" onclick="copyLink()">
                            <i class="fas fa-copy"></i> Salin
                        </button>
                        <button class="btn btn-secondary" onclick="shareLink()">
                            <i class="fas fa-share-alt"></i> Bagikan
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div style="background: white; padding: 1rem; border-radius: 0.75rem;">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;"><i class="fas fa-gift" style="color: var(--primary); margin-right: 0.5rem;"></i>Bonus Pendaftaran</p>
                            <p style="font-size: 1.25rem; font-weight: 700;">Rp 50</p>
                            <p style="font-size: 0.75rem; color: var(--gray-light);">Setiap teman yang mendaftar & menyelesaikan 1 iklan</p>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 0.75rem;">
                            <p style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;"><i class="fas fa-percentage" style="color: var(--secondary); margin-right: 0.5rem;"></i>Komisi Seumur Hidup</p>
                            <p style="font-size: 1.25rem; font-weight: 700;">20%</p>
                            <p style="font-size: 0.75rem; color: var(--gray-light);">Dari setiap penghasilan teman yang diundang</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Referred Users -->
            <div class="card">
                <div class="card-header">
                    <h3 style="font-size: 1.125rem;"><i class="fas fa-users" style="color: var(--primary); margin-right: 0.5rem;"></i>Teman yang Diundang</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-container" style="box-shadow: none;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Tanggal Daftar</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="referredTable">
                                <tr>
                                    <td colspan="3" style="text-align: center; color: var(--gray); padding: 3rem;">
                                        <i class="fas fa-user-friends" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                                        <p>Belum ada teman yang diundang</p>
                                        <p style="font-size: 0.875rem;">Bagikan link referral Anda untuk mulai mengundang</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Storage
        const Storage = {
            getUsers() {
                return JSON.parse(localStorage.getItem('adsduitid_users') || '[]');
            },
            getCurrentUser() {
                return JSON.parse(localStorage.getItem('adsduitid_current_user') || 'null');
            },
            getTransactions() {
                return JSON.parse(localStorage.getItem('adsduitid_transactions') || '[]');
            }
        };

        // Format
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
            });
        }

        // Toast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Check login
        let currentUser = Storage.getCurrentUser();
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // Update display
        function updateDisplay() {
            const users = Storage.getUsers();
            const referredUsers = users.filter(u => u.referredBy === currentUser.id);
            
            document.getElementById('totalReferred').textContent = referredUsers.length;
            document.getElementById('activeReferred').textContent = referredUsers.filter(u => u.totalPenghasilan > 0).length;
            
            const transactions = Storage.getTransactions();
            const refEarnings = transactions
                .filter(t => t.userId === currentUser.id && (t.type === 'referral_bonus' || t.type === 'referral_commission'))
                .reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('refEarnings').textContent = formatRupiah(refEarnings);
            
            // Referral link
            const refLink = `${window.location.origin}/pages/register.html?ref=${currentUser.referralCode}`;
            document.getElementById('referralLink').value = refLink;
            
            // Update table
            const tbody = document.getElementById('referredTable');
            if (referredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--gray); padding: 3rem;">
                            <i class="fas fa-user-friends" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <p>Belum ada teman yang diundang</p>
                            <p style="font-size: 0.875rem;">Bagikan link referral Anda untuk mulai mengundang</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = referredUsers.map(u => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${u.nama.charAt(0).toUpperCase()}</div>
                                ${u.nama}
                            </div>
                        </td>
                        <td>${formatDate(u.createdAt)}</td>
                        <td><span class="badge badge-${u.totalPenghasilan > 0 ? 'success' : 'warning'}">${u.totalPenghasilan > 0 ? 'Aktif' : 'Pending'}</span></td>
                    </tr>
                `).join('');
            }
        }

        function copyLink() {
            const link = document.getElementById('referralLink').value;
            navigator.clipboard.writeText(link);
            showToast('Link referral berhasil disalin!');
        }

        function shareLink() {
            const link = document.getElementById('referralLink').value;
            if (navigator.share) {
                navigator.share({
                    title: 'Gabung AdsDuitID - Dapatkan Uang dari Iklan',
                    text: `Daftar di AdsDuitID menggunakan kode referral saya ${currentUser.referralCode} dan dapatkan bonus!`,
                    url: link
                });
            } else {
                copyLink();
            }
        }

        function logout() {
            localStorage.setItem('adsduitid_current_user', JSON.stringify(null));
            window.location.href = '../index.html';
        }

        // Init
        updateDisplay();
    </script>
</body>
</html>
